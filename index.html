<html>
  <head>
    <script src='./js/vendor/jquery-2.2.0.min.js'></script>
    <link rel="stylesheet" type="text/css" href="semantic/dist/semantic.min.css">
    <script src="semantic/dist/semantic.min.js"></script>
  </head>
  <body>
    <div class ="ui inverted segment">
      <div class="ui grid">
        <div class="one column centered row teal">
                <h1>Genesys Packager</h1>
        </div>
        <div class="one column centered row">
          <div class="ui inverted segment">
              <div class="ui inverted form">
                <div class="field">
                  <label>Select your Unreal Engine Binaries Directory</label>
                  <p id="CurrBinDir">Current Bin Directory: </p>
                  <input type="file" id="UEBinDir" nwdirectory/>
                </div>
                <br/>
                <div class ="field">
                  <label> Select your content project</label>
                  <input type="file" id="ContentProject" nwdirectory/>
                </div>
                <br/>
                <input type="button" class="ui button teal" id="Package" value="Package"/>
              </div>
          </div>
        </div>
        <div id="cmd_out" class="one column centered row">
        </div>
      </div>
    </div>

    <script src="js/vendor/jquery.min.js"></script>
    <script>
      $(document).ready(function () {
        $("#CurrBinDir").append(localStorage.UEBinDir);
        $("#UEBinDir")[0].nwworkingdir = localStorage.UEBinDir;

        $("#UEBinDir").on("change",function(){
          localStorage.UEBinDir = this.value;
        });

        $("#Package").on("click",function(){

          //Validate input
          if($('#PakFileName').val() == ""){
            return alert("You must name your package");
          }

          var projectDir = $('#ContentProject')[0].value;

          if(projectDir == '' || projectDir == undefined){
            return alert("You must select your content project");
          }

          var projectName = projectDir.split("\\").slice(-1)[0];
          console.log(projectName);

          var fs = require('fs');
          //Create temporary file to hold UnrealPak args
          fs.open('./tmp/pakArgs.txt','w',function(err,fd){
            if(err){
              return alert(err);
            }
            var toWrite = '';

            var cookedPath = projectDir + "\\Saved\\Cooked\\WindowsNoEditor\\" + projectName + "\\Content\\" + projectName;

            //Generate Pak Args for mesh assets
            var cookedMeshesPath = cookedPath + "\\Meshes";
            console.log("Cooked Meshes Path: " + cookedMeshesPath);
            var cookedAssets = fs.readdirSync(cookedMeshesPath);
            for(var i=0;i<cookedAssets.length;i++){
              console.log("Processing: " + cookedAssets[i]);
              var sourceDir = "\"" + cookedMeshesPath + "\\" + cookedAssets[i] + "\"";
              var mountPoint = "\"" + "../../../Genesys/Content/" + projectName + "/Meshes/" + cookedAssets[i] + "\"";
              toWrite = toWrite + sourceDir + " " + mountPoint + "\r\n";
            }

            //Generate Pak Args for mesh materials
            var cookedMaterialsPath = cookedPath + "\\Materials";
            console.log("Cooked Materials Path: " + cookedMaterialsPath);
            var cookedMaterials = fs.readdirSync(cookedMaterialsPath);
            for(var i=0;i<cookedMaterials.length;i++){
              var sourceDir = "\"" + cookedMaterialsPath + "\\" + cookedMaterials[i] + "\"";
              var mountPoint = "\"" + "../../../Genesys/Content/" + projectName + "/Materials/" + cookedMaterials[i] + "\"";
              toWrite = toWrite + sourceDir + " " + mountPoint + "\r\n";
            }

            //Generate Pak Args for mesh textures
            var cookedTexturesPath = cookedPath + "\\Textures";
            console.log("Cooked Textures Path: "+ cookedTexturesPath);
            var cookedTextures = fs.readdirSync(cookedTexturesPath);
            for(var i=0;i<cookedTextures.length;i++){
              var sourceDir = "\"" + cookedTexturesPath + "\\" + cookedTextures[i] + "\"";
              var mountPoint = "\"" + "../../../Genesys/Content/" + projectName + "/Textures/" + cookedTextures[i] + "\"";
              toWrite = toWrite + sourceDir + " " + mountPoint + "\r\n";
            }


            fs.write(fd,toWrite,function(err,written,string){
              if(err){
                return alert(err);
              }

              fs.close(fd,function(){
                var path = require('path');
                var pakArgsDir = path.resolve('./tmp','pakArgs.txt');
                var saveDir = path.resolve('./') + "\\" + projectName + ".pak";

                var unrealPakDir = "\"" + path.resolve(localStorage.UEBinDir,"UnrealPak.exe") + "\"";
                //Pak Args creation success, call UnrealPak.exe
                var exec = require('child_process').exec;
                var cmd = unrealPakDir  + " " + saveDir + " -Create=" + pakArgsDir;
                exec(cmd, function(err, stdout, stderr) {
                  if(err){
                    console.log(err);
                    return alert(err);
                  }
                  else{
                    alert("Packaging Success: " + saveDir);
                  }
                });
              });

            });

          });
        });
      });
    </script>
  </body>
</html>
